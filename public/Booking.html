<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <meta name="description" content="" />
    <meta name="author" content="" />
    <title>stART::맨끝줄소년</title>
     <!-- Favicon-->
     <link rel="icon" href="image/x-icon.png" />
     <link rel="apple-touch-icon" href="image/x-icon.png" />     

    <!-- Bootstrap icons-->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="style.css">
    <!--google font-->
    <link
      href="https://fonts.googleapis.com/css?family=Song+Myung|Libre+Barcode+39|Nanum+Gothic+Coding|DM+Serif+Display|Noto+Serif+KR:wght@500;600&display=swap"
      rel="stylesheet"
    />
    <!-- Fire Base-->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <!-- Firebase 데이터 삽입을 위한 JavaScript 코드 -->
    <script>
      //  web app's Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyA4rOYodV29z8d4_O4ewTMV1qQDDWhfeho",
        authDomain: "start-ba2c0.firebaseapp.com",
        projectId: "start-ba2c0",
        storageBucket: "start-ba2c0.appspot.com",
        messagingSenderId: "38449035061",
        appId: "1:38449035061:web:fec9627e6bf3eab1b53e7c",
      };
      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      // Get a reference to the database service
      var database = firebase.database();
    </script>
    <!-- Firestore Library 추가 -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  </head>
</html>
<body class="d-flex flex-column">
  <main class="flex-shrink-0">
    <!-- Navigation-->
    <nav class="navbar navbar-expand-lg bg-white">
      <div class="container px-3">
        <a class="start" href="index.html">stART</a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarSupportedContent"
          aria-controls="navbarSupportedContent"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
          <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
            <li class="nav-item">
              <a class="nav-link myungjo" href="Booking.html"
                >예매하기</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link myungjo" href="manageBooking.html"
                >예매 확인/취소</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link myungjo" href="faq.html">FAQ</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>
    <!-- Page content-->
    <section class="py-5 myungjo">
      <div class="container px-3 center">
        <div class="infoBox py-3">
          <!--공연정보 요약-->
          <div class="row">
            <div class="posterbox col-xl-6 m-2">
              <img class="posterImg" src="https://tumblbug-psi.imgix.net/ecb5f2d41403eeada85f3ca258f97370a82f873a/7ae757732bce4e84faa3c4140ebbe61b6fa0058d/c01a5aaf765544642ef04359d9184a4580372fec/89492b93-1f52-4b74-9e2f-b6a809014123.jpg?ixlib=rb-1.1.0&w=1240&auto=format%2C%20compress&lossless=true&ch=save-data&s=8cdd59ff025c301795bc99c2fe1c751c" alt="연극 <맨끝줄소년>">
            </div>
            <div class="info_summary col-xl-6 m-2">
              <div class="mb-3">
                <span class="title">연극&nbsp;&nbsp;&nbsp;<맨 끝줄 소년></span>
              </div>
              <ul class="info">
                <li class="infoItem">
                  <strong class="infoLabel">장소</strong>
                  <div class="infoDesc"><p class="infoText">이화여자대학교 생활환경관 소극장</p></div>
                </li>
                <li class="infoItem">
                  <strong class="infoLabel">공연기간</strong>
                  <div class="infoDesc"><p class="infoText">2024.02.15~2024.02.17</p></div>
                </li>
                <li class="infoItem">
                  <strong class="infoLabel">공연시간</strong>
                  <div class="infoDesc"><p class="infoText">120분</p></div>
                </li>
                <li class="infoItem">
                  <strong class="infoLabel">가격</strong>
                  <div class="infoDesc"><p class="infoText">전좌석 12,000원</p></div>
                </li>
              </ul>
            </div>
          </div>
        </div>

        <form id="selectdateForm" data-sb-form-api-token="API_TOKEN">
          
          <div class="dateBox py-5 px-4">
            <div class="row selectTitle">
              <h5 class="col-lg-4 px-5">날짜선택</h5><h5 class="col-lg-4 px-5">회차선택</h5><h5 class="col-lg-4 px-5">예매 매수 선택</h5>
            </div>
            <div class="row mb-3">
              <div class="datelistBox col-lg-4">
                <ul class="datelist">
                  <li class="mb-3">
                    <input type="radio" class="btn-check" name="date" id="option1" value="240215" autocomplete="off" checked>
                    <label class="btn" for="option1"><span class="datetext">2024년 2월 15일 (목)</span></label>
                  </li>
                  <li class="mb-3">
                    <input type="radio" class="btn-check" name="date" id="option2" value="240216" autocomplete="off">
                    <label class="btn" for="option2"><span class="datetext">2024년 2월 16일 (금)</span></label>
                  </li>
                  <li class="mb-3">
                    <input type="radio" class="btn-check" name="date" id="option3" value="240217" autocomplete="off">
                    <label class="btn" for="option3"><span class="datetext">2024년 2월 17일 (토)</span></label>
                  </li>
                </ul>
              </div>
              <div class="datelistBox col-lg-4">
                <ul class="datelist">
                  <li class="mb-3">
                    <input type="radio" class="btn-check" name="time" id="option" autocomplete="off" checked>
                    <label class="btn" for="option" value="1회차"><span class="datetext">1회차 20:00</span></label>
                  </li>
                </ul>
              </div>
              <div class="numticketBox col-lg-4">
                <div class="datelist mb-3">
                  <select class="form-select" name="ticketnum" id="floatingSelect">
                    <option value="1" selected>1매</option>
                    <option value="2">2매</option>
                    <option value="3">3매</option>
                    <option value="4">4매</option>
                    <option value="5">5매</option>
                    <option value="6">6매</option>
                    <option value="7">7매</option>
                    <option value="8">8매</option>
                    <option value="9">9매</option>
                  </select>
                </div>
              </div>
            </div>
          </div>
          <div class="d-flex justify-content-center">
            <button type="submit" class="btn btn-dark" id="openModalBtn">예매하기</button>
          </div>
        </form>
      </div>
    </section>
    

    <!-- 모달 창 1 -->
    <div
      class="modal fade myungjo"
      id="reservationModal"
      tabindex="-1"
      aria-labelledby="exampleModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLabel">예매자 정보 입력</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
              id="closeModal1"
            ></button>
          </div>
          <form id="userForm" data-sb-form-api-token="API_TOKEN">
            <div class="modal-body">
              <div id="bookinginput" style="white-space: pre-line"></div>
                <div class="inputBox bg-light rounded-3 mb-5">
                  <div class="infoDesc"><p class="infoText fw-bolder">예매정보</p></div>
                  <!--선택한 날짜 보여주는 영역-->
                  <div class="inputTable px-3 row">
                    <div class="col-lg-4 mb-3">관람일</div><div class="col-xl-6 mb-3" id="selectedDate"></div>
                  </div>
                  <div class="inputTable px-3 row">
                    <div class="col-lg-4">예매매수</div><div class="col-xl-6" id="selectedTicket"></div>
                  </div>
                </div>
                <!-- 예매자 정보 입력 영역 -->
                <div class="inputBox bg-light rounded-3 mb-5">
                  <div class="infoDesc"><p class="infoText fw-bolder">할인 선택</p></div>
                  <div class="inputTable px-3">
                    <div class="row">
                      <div class="discount col-lg-4 mb-3"><p class="type">일반</p></div><div class="discount col-lg-4 mb-3"><p class="price">12,000원</p></div>
                      <div class="col-lg-4 mb-3">
                        <select class="form-select" id="generalDiscountSelect">
                          <option value="0">0매</option>
                        </select>
                      </div>
                    </div>  
                    <div class="row">
                      <div class="discount col-lg-4 mb-3"><p class="type">재학생 할인</p></div><div class="discount col-lg-4 mb-3"><p class="price">10,000원</p></div>
                      <div class="col-lg-4 mb-3">
                        <select class="form-select" id="studentDiscountSelect">
                          <option value="0" selected>0매</option>
                          <option value="1">1매</option>
                        </select>
                      </div>
                    </div>
                    <div class="row">
                      <div class="discount col-lg-4 mb-3"><p class="type">SNS 팔로우 할인</p></div><div class="discount col-lg-4 mb-3"><p class="price">10,000원</p></div>
                      <div class="col-lg-4 mb-3">
                        <select class="form-select" id="followDiscountSelect">
                          <option value="0" selected>0매</option>
                          <option value="1">1매</option>
                        </select>
                      </div>
                    </div>
                    <div class="row">
                      <div class="discount col-lg-4 mb-3"><p class="type">재관람 할인</p></div><div class="discount col-lg-4 mb-3"><p class="price">9,000원</p></div>
                      <div class="col-lg-4">
                        <select class="form-select" id="reviewDiscountSelect">
                          <option value="0" selected>0매</option>
                          <option value="1">1매</option>
                        </select>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="inputBox bg-light rounded-3 mb-5">
                  <div class="infoDesc"><p class="infoText fw-bolder">예매자명</p></div>
                  <!-- 예매자명 입력란 -->
                  <div class="form-floating mb-3">
                    <input
                      class="form-control"
                      id="reservationName"
                      type="text"
                      placeholder="예매자명"
                      data-sb-validations="required"
                      required
                    />
                    <div class="invalid-feedback" data-sb-feedback="reservationName:required">
                      예매자명을 입력해 주세요.
                    </div>
                  </div>  
                </div>
        
                <div class="inputBox bg-light rounded-3 mb-5">
                  <div class="infoDesc"><p class="infoText fw-bolder">이메일</p></div>
                  <!-- Email address input-->
                  <div class="form-floating mb-3">
                    <input
                      class="form-control"
                      id="email"
                      type="email"
                      placeholder="name@example.com"
                      data-sb-validations="required,email"
                      required
                    />
                    <label for="email">lastcode@gmail.com</label>
                    <div
                      class="invalid-feedback"
                      data-sb-feedback="email:required"
                    >
                      이메일을 입력해 주세요.
                    </div>
                    <div class="invalid-feedback" data-sb-feedback="email:email">
                      이메일 형식이 올바르지 않습니다.
                    </div>
                  </div>
                </div>
        
                <div class="inputBox bg-light rounded-3 mb-5">
                  <div class="infoDesc"><p class="infoText fw-bolder">연락처</p></div>
                  <div class="form-floating mb-3">
                    <input
                      class="form-control"
                      id="phoneNumber"
                      type="tel"
                      placeholder="전화번호"
                      data-sb-validations="required"
                      required 
                    />
                    <label for="phoneNumber">01012341234</label>
                    <div class="invalid-feedback" data-sb-feedback="phoneNumber:required">
                      연락처를 입력해 주세요.
                    </div>
                    <div class="invalid-feedback" data-sb-feedback="phoneNumber:format">
                      숫자만 입력해 주세요.
                    </div>
                  </div>
                </div>

                <div class="inputBox bg-light rounded-3 mb-5">
                  <div class="infoDesc"><p class="infoText fw-bolder">예매자 동의</p></div>
                  <!--취소 수수료 동의-->
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="agreementCheckbox" required>
                    <label class="form-check-label" for="agreementCheckbox">
                      <p class="infoDesc">예매 및 취소 수수료/취소 기한을 확인하였으며 동의합니다.</p>
                    </label>
                    <!--취소 수수료 안내-->
                  </div>
                </div>
            </div>
            <div class="modal-footer">
              <!-- 결제하기 버튼 -->
              <button type="submit" class="btn btn-dark" id="paying">결제하기</button>
            </div>
          </form> 
        </div>
      </div>
    </div>

    <!-- 모달 창 2 -->
    <div
      class="modal fade myungjo"
      id="payModal"
      tabindex="-1"
      aria-labelledby="exampleModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLabel">결제</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
              id="closeModal2"
            ></button>
          </div>
          <div class="modal-body">
            <div id="bookinginput" style="white-space: pre-line"></div>
              <!-- 계좌 안내 영역 -->
              <div class="inputBox rounded-3 mb-3">
                <div class="accInfo fw-bolder">무통장 입금 안내</div>
                <br><br>
                <p id="bookingName"></p>
                <p id="totalPrice"></p>
                <br>
                <div class="accInfo fw-bolder">계좌번호 7979-89-15908<br>입금주 박수현</div>
              </div>
              <div class="inputBox bg-light rounded-3 mb-3">
                <p class="inputTable">- 입금 시 <span class="fw-bolder">예매자명과 입금자명이 동일</span>한 지, <span class="fw-bolder">금액이 정확</span>한 지 한 번 더 확인해주세요.<br>- 본 예매처의 입금 확인은 <span class="fw-bolder">수동 입금 확인 시스템</span>으로 입금 시 24시간 이내에 고객님의 예매 내역이 '입금대기' 상태에서 '예매확정' 상태로 변환될 예정입니다.<br></p>
              </div>
          </div>
          <div class="modal-footer">
            <!-- 확인 버튼 -->
            <button id="checkBooking" type="button" class="btn btn-dark" onclick="redirectToManageBooking()">
              예매 내역 확인
            </button>
          </div>
        </div>
      </div>
    </div>

  </main>

  <script>
    document .getElementById("selectdateForm") .addEventListener("submit", function (event) {
      event.preventDefault();

      //공연일 가져오기
      var selectedDate = getSelectedRadioValue("date");
      // 라디오 버튼의 값을 가져오는 함수
      function getSelectedRadioValue(name) {
        var radioButtons = document.getElementsByName(name);
        for (var i = 0; i < radioButtons.length; i++) {
          if (radioButtons[i].checked) {
            return radioButtons[i].value;
          }
        }
      }

      if(selectedDate=="240215"){
        document.getElementById("selectedDate").innerHTML = "2024.02.15(목) 20:00";
      }else if(selectedDate=="240216"){
        document.getElementById("selectedDate").innerHTML = "2024.02.16(금) 20:00";
      }else if(selectedDate=="240217"){
        document.getElementById("selectedDate").innerHTML = "2024.02.17(토) 15:00";
      };

      //예매매수 가져오기
      var ticketnum = getSelectedDropdownValue("ticketnum");
      // 드롭다운의 값을 가져오는 함수
      function getSelectedDropdownValue(name) {
        var dropdown = document.getElementsByName(name)[0];
        var selectedValue = dropdown.options[dropdown.selectedIndex].value;
        return selectedValue;
      }

      document.getElementById("selectedTicket").innerHTML = ticketnum+"매";


      //예매매수만큼만 드롭다운 출력하기
      function updateSelectOptions(selectId) {
        var floatingSelect = document.getElementById("floatingSelect").value;
        var discountSelect = document.getElementById(selectId);
      
        // Add new options based on the selected value
        for (var i = 1; i <= floatingSelect; i++) {
          var option = document.createElement("option");
          option.value = i;
          option.text = i + "매";
          discountSelect.add(option);
        }
      }
      updateSelectOptions("generalDiscountSelect");

      $("#reservationModal").modal("show");

    });
      
    // 모달 창 닫기 버튼 이벤트 핸들러
    document.getElementById("closeModal1").addEventListener("click", function () {
        reservationModal.style.display = "none";
        var modalBackdrop = document.querySelector(".modal-backdrop");
        if (modalBackdrop) {
          modalBackdrop.remove();
        }
    });

    document .getElementById("userForm") .addEventListener("submit", function (event) {
      // 이벤트 기본 동작 막기
      event.preventDefault();

      // 할인 정보 가져오기
      var discountGeneral = parseFloat(document.getElementById("generalDiscountSelect").value);
      var discountStudent = parseFloat(document.getElementById("studentDiscountSelect").value);
      var discountFollow = parseFloat(document.getElementById("followDiscountSelect").value);
      var discountReview = parseFloat(document.getElementById("reviewDiscountSelect").value);

      // 선택 매수 가져오기
      var selectedQuantity = parseFloat(document.getElementById("floatingSelect").value);
      // 할인 정보 합산
      var totalDiscount = discountGeneral + discountStudent + discountFollow + discountReview;
      // 조건 확인
      if (totalDiscount !=  selectedQuantity) {
        // 조건이 일치하지 않을 경우 알림창 띄우기
        alert("선택 매수와 할인 권종 선택 수가 일치하지 않습니다.");
      }
      var formData = {
        email: document.getElementById("email").value,  
        reservationName: document.getElementById("reservationName").value,
        phoneNumber: document.getElementById("phoneNumber").value,
        date: document.querySelector('input[name="date"]:checked').value,
        progress: "입금대기",
        DiscountGeneral: discountGeneral,
        DiscountStudent: discountStudent,
        DiscountFollow: discountFollow,
        DiscountReview: discountReview
      };

      $("#reservationModal").modal("hide");
      $("#payModal").modal("show");

      //payModal에 예매자명과 금액 띄우기
      var reservationName = document.getElementById("reservationName").value;
      document.getElementById("bookingName").innerHTML = "예매자명: "+reservationName;

      var totalPrice = Number(discountGeneral)*12000+Number(discountStudent)*10000+Number(discountFollow)*10000+Number(discountReview)*9000;
      document.getElementById("totalPrice").innerHTML = "입금 대기 금액: "+ totalPrice +"원";
    
      // Firebase에 추가
      var reservationsRef = database.ref("BookingList");
      reservationsRef.push(formData)
        .then(function () {
          console.log("Data successfully stored in Firebase!");
        })
        .catch(function (error) {
          console.error("Error storing data in Firebase: ", error);
        });
      
    });
    
    document.getElementById("closeModal2").addEventListener("click", function () {
      payModal.style.display = "none";
      var modalBackdrop = document.querySelector(".modal-backdrop");
      if (modalBackdrop) {
        modalBackdrop.remove();
      }
    });

    function redirectToManageBooking() {
      // 모달 창 닫기
      $('#payModal').modal('hide');
      
      // 예매 내역 관리 페이지로 이동
      window.location.href = 'manageBooking.html';
    }
  </script>
</body>