<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <meta name="description" content="" />
    <meta name="author" content="" />
    <title>stART::맨끝줄소년</title>
    <link rel="icon" href="image/x-icon.png" />
    <link rel="apple-touch-icon" href="image/x-icon.png" />

    <!-- Bootstrap icons-->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9"
      crossorigin="anonymous"
    />
    <!--덮어쓰는 css-->
    <link href="style.css" rel="stylesheet" />
    <!--Google Font-->
    <link
      href="https://fonts.googleapis.com/css?family=Song+Myung|Libre+Barcode+39|Nanum+Gothic+Coding|DM+Serif+Display|Noto+Serif+KR:wght@500;600&display=swap"
      rel="stylesheet"
    />

    <!-- Firestore Library 추가 -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <!-- Firestore Library 추가 -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <!-- Fire Base-->
    <script>
      //  web app's Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyA4rOYodV29z8d4_O4ewTMV1qQDDWhfeho",
        authDomain: "start-ba2c0.firebaseapp.com",
        projectId: "start-ba2c0",
        storageBucket: "start-ba2c0.appspot.com",
        messagingSenderId: "38449035061",
        appId: "1:38449035061:web:fec9627e6bf3eab1b53e7c",
      };
      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      // Get a reference to the database service
      var database = firebase.database();
    </script>
  </head>
</html>
<body class="d-flex flex-column">
  <main class="flex-shrink-0">
    <!-- Navigation-->
    <nav class="navbar navbar-expand-lg bg-white">
      <div class="container px-5">
        <a class="start" href="index.html">stART</a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarSupportedContent"
          aria-controls="navbarSupportedContent"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
          <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
            <li class="nav-item">
              <a class="nav-link myungjo" href="Booking.html"
                >예매하기</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link myungjo" href="manageBooking.html"
                >예매 확인 </a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link myungjo" href="faq.html">FAQ</a>
            </li>
            <!-- <li class="nav-item">
              <a class="nav-link myungjo" href="chatbot.html">(계속)</a>
            </li> -->
          </ul>
        </div>
      </div>
    </nav>

    <!-- Page content-->
    <section class="py-5 myungjo">
      <div class="container px-5">
        <!-- Input form-->
        <div class="bg-white rounded-3 py-5 px-4 px-md-5 mb-5">
          <div class="text-center mb-5">
            <div
              class="feature bg-primary bg-gradient text-white rounded-3 mb-3"
            >
              <i class="bi bi-envelope"></i>
            </div>
            <h1 class="fw-bolder myungjo">환불 신청서 작성</h1>
            <p class="lead fw-normal text-muted mb-0 myungjo">
              환불 정보를 입력합니다.
            </p>
          </div>
          <div class="row gx-5 justify-content-center">
            <div class="col-lg-8 col-xl-6">
              <form id="userForm">
                <!-- Name input-->
                <div class="form-floating mb-3">
                  <input
                    class="form-control"
                    id="name"
                    type="text"
                    placeholder="Name"
                    data-sb-validations="required"
                  />
                  <label for="name">입금자명</label>
                  <div
                    class="invalid-feedback"
                    data-sb-feedback="name:required"
                  >
                    올바른 이름을 입력해 주세요.
                  </div>
                </div>
                <div
                      class="invalid-feedback"
                      data-sb-feedback="name:required"
                    >
                      A name is required.
                    </div>
               <!-- Email address input-->
<div class="form-floating mb-3">
  <input
    class="form-control"
    id="email"
    type="email"
    placeholder="name@example.com"
    data-sb-validations="required,email"
    required
    pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$"
  />
  <label for="email">이메일 주소</label>
  <div
    class="invalid-feedback"
    data-sb-feedback="email:required"
  >
    이메일을 입력해 주세요.
  </div>
  <div class="invalid-feedback">
    이메일 주소 형식이 올바르지 않습니다.
  </div>
</div>

                <!-- Phone number input-->
                <div class="form-floating mb-3">
                  <input
                    class="form-control"
                    id="phone"
                    type="tel"
                    placeholder="(123) 456-7890"
                    data-sb-validations="required"
                  />
                  <label for="phone">전화번호 ( - 없이 입력하세요.)</label>
                  <div
                    class="invalid-feedback"
                    data-sb-feedback="phone:required"
                  >
                    올바른 전화번호를 입력해 주세요.
                  </div>
                </div>
                <!-- Account input-->
                <div class="input-group mb-3">
                  <div class="input-group-prepend">
                    <label class="input-group-text" for="inputGroupSelect01"
                      >은행명</label
                    >
                  </div>
                  <select class="form-select" id="inputGroupSelect01">
                    <option selected>은행</option>
                    <option value="국민은행">국민은행</option>
                    <option value="기업은행">기업은행</option>
                    <option value="농협은행">농협은행</option>
                    <option value="신한은행">신한은행</option>
                    <option value="산업은행">산업은행</option>
                    <option value="우리은행">우리은행</option>
                    <option value="한국씨티은행">한국씨티은행</option>
                    <option value="하나은행">하나은행</option>
                    <option value="SC제일은행">SC제일은행</option>
                    <option value="경남은행">경남은행</option>
                    <option value="광주은행">광주은행</option>
                    <option value="대구은행">대구은행</option>
                    <option value="도이치은행">도이치은행</option>
                    <option value="부산은행">부산은행</option>
                    <option value="전북은행">전북은행</option>
                    <option value="제주은행">제주은행</option>
                  </select>
                </div>
                <div class="form-floating mb-3">
                  <input
                    class="form-control"
                    id="account"
                    type="tel"
                    placeholder="1002755451234"
                    data-sb-validations="required"
                  />
                  <label for="account">계좌 번호</label>
                  <div
                    class="invalid-feedback"
                    data-sb-feedback="account:required"
                  >
                    올바른 계좌 번호를 입력해 주세요.
                  </div>
                </div>
                <div class="row g-2">
                  <!-- Label -->
                  <div class="input-group-prepend">
                    <label for="date" class="form-label">입금 날짜</label>
                  </div>

                  <!-- Date input -->
                  <div class="col-md">
                    <input
                      type="date"
                      class="form-control"
                      id="date"
                      max="2024-02-17"
                      min="2024-01-07"
                      value="2024-01-30"
                    />
                    <div
                      class="invalid-feedback"
                      data-sb-feedback="date:required"
                    >
                      올바른 입금 날짜를 입력해 주세요.
                    </div>
                  </div>
                </div>
                <!-- Add margin-top -->
                <div class="mt-3">
                  <!-- Price input-->
                  <div class="form-floating mb-3">
                    <input
                      class="form-control"
                      id="price"
                      type="text"
                      placeholder="10000"
                      data-sb-validations="required"
                    />
                    <label for="price">입금 금액 (ex. 12000)</label>
                    <div
                      class="invalid-feedback"
                      data-sb-feedback="price:required"
                    >
                      올바른 입금 금액을 입력해 주세요.
                    </div>
                  </div>
                </div>
                <div class="d-flex justify-content-center">
                  <button
                    type="submit"
                    class="btn btn-dark myungjo"
                    id="confirmButton"
                  >
                    확인
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>
  <script>
document
  .getElementById("confirmButton")
  .addEventListener("click", function (event) {
    event.preventDefault();

    // 입력 필드에서 데이터를 가져옵니다.
    var name = document.getElementById("name").value;
    var email = document.getElementById("email").value;
    var phoneNumber = document.getElementById("phone").value;
    var date = document.getElementById("date").value;
    var bank = document.getElementById("inputGroupSelect01").value;
    var account = document.getElementById("account").value;
    var price = document.getElementById("price").value;
    
    // 모든 필드가 채워져 있는지 확인합니다.
    if (!name || !email || !phoneNumber || !date || !bank || !account || !price) {
        alert("모든 필드를 채워주세요.");
        return;  // 필드가 빈 경우 함수를 종료합니다.
    }
    // 이메일 주소 유효성 검사
    var emailPattern = /^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,4}$/;
    if (!emailPattern.test(email)) {
        alert("이메일 주소 형식이 올바르지 않습니다.");
        return;  // 이메일 주소 형식이 올바르지 않은 경우 함수를 종료합니다.
    }
    // 전화번호 유효성 검사
    var phonePattern = /^\d{11}$/;
    if (!phonePattern.test(phoneNumber)) {
        alert("전화번호는 11자리 숫자여야 합니다.");
        return;  // 전화번호 형식이 올바르지 않은 경우 함수를 종료합니다.
    }

    // BookingList에서 해당 예매 내역을 찾습니다.
    var bookingRef = database.ref("BookingList");
    var query = bookingRef.orderByChild("email").equalTo(email);

    query.once("value", function(snapshot) {
      snapshot.forEach(function(childSnapshot) {
        // 조건에 맞는 데이터가 있다면, 그 데이터의 progress 값을 '환불대기'로 변경합니다.
        if (childSnapshot.val().progress === "예매확정") {
          bookingRef.child(childSnapshot.key).update({progress: "환불대기"});
        }});
    
    }).then(() => {
        // 이제 BookingList에서 progress 변경 작업이 완료되었으므로, CancelList에 데이터를 저장합니다.
        database
          .ref("CancelList")
          .push()
          .set({
            name: name,
            email: email,
            phoneNumber: phoneNumber,
            date: date,
            bank: bank,
            account: account,
            price: price
          })
          .then(() => {
            // 데이터가 성공적으로 저장된 후에 실행됩니다.
            alert("환불 신청이 완료되었습니다. 감사합니다.");
            window.location.href = "index.html";
          })
          .catch((error) => {
            // 저장 중에 오류가 발생하면 실행됩니다.
            console.error("Error writing new message to database", error);
          });
      });
});

  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Core theme JS-->
  <script src="js/scripts.js"></script>
  <script type="module">
  </script>
</body>
